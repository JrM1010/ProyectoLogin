@{
    ViewData["Title"] = "Punto de Venta";
}

<div class="container-fluid mt-3">
    <div class="row g-3">

        <!-- =========================== -->
        <!-- 🔹 PANEL IZQUIERDO: PRODUCTOS -->
        <!-- =========================== -->
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-basket2-fill"></i> Punto de Venta</h5>
                    <div class="search-container">
                        <input type="text" id="busqueda" class="form-control form-control-sm"
                               placeholder="Buscar producto por nombre o código..." autocomplete="off" />
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0 align-middle text-center" id="tablaProductos">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 35%;">Descripción del Producto</th>
                                    <th>Precio</th>
                                    <th>Cantidad</th>
                                    <th>Desc. %</th>
                                    <th>Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- =========================== -->
        <!-- 🔹 PANEL DERECHO: ACCIONES Y TOTALES -->
        <!-- =========================== -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title text-center text-primary fw-bold">Resumen de Venta</h5>
                    <hr />

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Cliente</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="clienteNombre" class="form-control" placeholder="Cliente no asignado" readonly>
                            <button class="btn btn-outline-secondary" id="btnAgregarCliente"><i class="bi bi-person-plus"></i></button>
                        </div>
                    </div>

                    <hr />

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Subtotal</label>
                        <input type="text" id="subtotal" class="form-control form-control-sm text-end" value="0.00" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">IVA (12%)</label>
                        <input type="text" id="iva" class="form-control form-control-sm text-end" value="0.00" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Total</label>
                        <input type="text" id="total" class="form-control form-control-sm text-end fw-bold fs-5 text-success" value="0.00" readonly />
                    </div>

                    <hr />

                    <!-- 🔹 BOTONES DE ACCIÓN RÁPIDA -->
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-success" id="btnCobrar"><i class="bi bi-cash-coin"></i> Cobrar / Pagar</button>
                        <button class="btn btn-outline-danger" id="btnCancelar"><i class="bi bi-x-circle"></i> Cancelar Venta</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- =========================== -->
<!-- 🔹 MODAL DE PAGO -->
<!-- =========================== -->
<div class="modal fade" id="modalCobro" tabindex="-1" aria-labelledby="modalCobroLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-cash-stack"></i> Finalizar Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Total a pagar: <strong class="text-success fs-5" id="totalCobro">Q0.00</strong></p>
                <div class="mb-3">
                    <label class="form-label">Monto recibido:</label>
                    <input type="number" id="montoRecibido" class="form-control" min="0" step="0.01" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Cambio:</label>
                    <input type="text" id="cambio" class="form-control" readonly />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" id="btnConfirmarCobro"><i class="bi bi-check2-circle"></i> Confirmar Pago</button>
            </div>
        </div>
    </div>
</div>

<!-- =========================== -->
<!-- 🔸 ESTILOS -->
<!-- =========================== -->
<style>
    .search-container {
        position: relative;
        display: inline-block;
        width: 50%;
    }

    .suggestions-box {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #dee2e6;
        border-top: none;
        z-index: 9999;
        max-height: 250px;
        overflow-y: auto;
        border-radius: 0 0 0.5rem 0.5rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

        .suggestions-box button {
            border: none;
            background: #fff;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
        }

            .suggestions-box button:hover {
                background: #f8f9fa;
            }
</style>

<!-- =========================== -->
<!-- 🔸 SCRIPT PRINCIPAL -->
<!-- =========================== -->
@section Scripts {
    <script>
        const tablaBody = document.querySelector("#tablaProductos tbody");
        const inputBusqueda = document.querySelector("#busqueda");
        const btnCobrar = document.querySelector("#btnCobrar");
        const btnCancelar = document.querySelector("#btnCancelar");
        const btnSuspender = document.querySelector("#btnSuspender");
        const btnAgregarCliente = document.querySelector("#btnAgregarCliente");

        let productosSeleccionados = [];
        let ultimosResultados = [];

        // ==========================================
        // 🔍 BÚSQUEDA DE PRODUCTOS (con Enter)
        // ==========================================
        inputBusqueda.addEventListener("keyup", async (e) => {
            const term = e.target.value.trim();
            const contenedor = inputBusqueda.closest(".search-container");
            if (term.length < 2) {
                const prev = contenedor.querySelector(".suggestions-box");
                if (prev) prev.remove();
                return;
            }
            const resp = await fetch(`/Ventas/BuscarProducto?term=${encodeURIComponent(term)}`);
            const data = await resp.json();
            ultimosResultados = data.results;
            mostrarSugerencias(ultimosResultados, contenedor);
        });

        inputBusqueda.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                if (ultimosResultados.length > 0) {
                    seleccionarProducto(ultimosResultados[0]);
                    const contenedor = inputBusqueda.closest(".search-container");
                    const lista = contenedor.querySelector(".suggestions-box");
                    if (lista) lista.remove();
                }
            }
        });

        function mostrarSugerencias(lista, contenedor) {
            const prev = contenedor.querySelector(".suggestions-box");
            if (prev) prev.remove();
            if (!lista.length) return;

            const div = document.createElement("div");
            div.classList.add("suggestions-box");
            lista.forEach(p => {
                const item = document.createElement("button");
                item.type = "button";
                item.innerHTML = `<strong>${p.text}</strong> <span class="text-muted float-end">Q${p.precio.toFixed(2)}</span>`;
                item.onclick = () => { seleccionarProducto(p); div.remove(); };
                div.appendChild(item);
            });
            contenedor.appendChild(div);
            document.addEventListener("click", (ev) => {
                if (!contenedor.contains(ev.target)) {
                    const list = contenedor.querySelector(".suggestions-box");
                    if (list) list.remove();
                }
            }, { once: true });
        }

        // ==========================================
        // 🧾 GESTIÓN DE PRODUCTOS EN VENTA
        // ==========================================
        function seleccionarProducto(prod) {
            const existente = productosSeleccionados.find(p => p.id === prod.id);
            if (existente) existente.cantidad++;
            else productosSeleccionados.push({ id: prod.id, nombre: prod.text, precio: parseFloat(prod.precio), cantidad: 1, descuento: 0 });
            inputBusqueda.value = "";
            renderTabla();
        }

        function renderTabla() {
            tablaBody.innerHTML = "";
            productosSeleccionados.forEach((p, i) => {
                const subtotal = p.precio * p.cantidad * (1 - p.descuento / 100);
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="text-start">${p.nombre}</td>
                    <td>Q${p.precio.toFixed(2)}</td>
                    <td>
                        <div class="input-group input-group-sm justify-content-center">
                            <button class="btn btn-outline-secondary btn-sm" onclick="cambiarCantidad(${i}, -1)">-</button>
                            <input type="number" min="1" class="form-control text-center" style="max-width:60px;" value="${p.cantidad}" onchange="actualizarCantidad(${i}, this.value)">
                            <button class="btn btn-outline-secondary btn-sm" onclick="cambiarCantidad(${i}, 1)">+</button>
                        </div>
                    </td>
                    <td><input type="number" class="form-control form-control-sm text-center" min="0" max="100" value="${p.descuento}" onchange="actualizarDescuento(${i}, this.value)"></td>
                    <td>Q${subtotal.toFixed(2)}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="eliminarProducto(${i})"><i class="bi bi-trash"></i></button></td>
                `;
                tablaBody.appendChild(tr);
            });
            recalcularTotales();
        }

        function cambiarCantidad(i, d) { productosSeleccionados[i].cantidad = Math.max(1, productosSeleccionados[i].cantidad + d); renderTabla(); }
        function actualizarCantidad(i, v) { productosSeleccionados[i].cantidad = Math.max(1, parseInt(v)); renderTabla(); }
        function actualizarDescuento(i, v) { productosSeleccionados[i].descuento = Math.max(0, parseFloat(v)); renderTabla(); }
        function eliminarProducto(i) { productosSeleccionados.splice(i, 1); renderTabla(); }

        function recalcularTotales() {
            let subtotal = 0;
            productosSeleccionados.forEach(p => subtotal += p.precio * p.cantidad * (1 - p.descuento / 100));
            document.querySelector("#subtotal").value = subtotal.toFixed(2);
            document.querySelector("#iva").value = (subtotal * 0.12).toFixed(2);
            document.querySelector("#total").value = (subtotal * 1.12).toFixed(2);
        }

        // ==========================================
        // ⚡ ACCIONES RÁPIDAS
        // ==========================================
        btnCancelar.addEventListener("click", () => {
            if (confirm("¿Seguro que deseas cancelar esta venta?")) {
                productosSeleccionados = [];
                renderTabla();
            }
        });

        btnSuspender.addEventListener("click", () => {
            if (productosSeleccionados.length === 0) return alert("No hay productos para suspender.");
            alert("🕓 Venta suspendida. Podrás retomarla más tarde.");
            productosSeleccionados = [];
            renderTabla();
        });

        btnCobrar.addEventListener("click", () => {
            const total = parseFloat(document.querySelector("#total").value);
            document.querySelector("#totalCobro").textContent = `Q${total.toFixed(2)}`;
            document.querySelector("#montoRecibido").value = "";
            document.querySelector("#cambio").value = "";
            new bootstrap.Modal(document.getElementById("modalCobro")).show();
        });

        document.querySelector("#montoRecibido").addEventListener("input", () => {
            const total = parseFloat(document.querySelector("#total").value);
            const recibido = parseFloat(document.querySelector("#montoRecibido").value);
            const cambio = recibido - total;
            document.querySelector("#cambio").value = cambio >= 0 ? `Q${cambio.toFixed(2)}` : "—";
        });

        document.querySelector("#btnConfirmarCobro").addEventListener("click", () => {
            alert("✅ Venta cobrada con éxito.");
            productosSeleccionados = [];
            renderTabla();
            bootstrap.Modal.getInstance(document.getElementById("modalCobro")).hide();
        });

        btnAgregarCliente.addEventListener("click", () => {
            const nombre = prompt("Ingrese el nombre del cliente:");
            if (nombre) document.querySelector("#clienteNombre").value = nombre;
        });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
}
