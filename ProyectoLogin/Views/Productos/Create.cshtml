@model ProyectoLogin.Models.ModelosProducts.ProductoCore
@{
    ViewData["Title"] = "Crear Producto";
}

<h2 class="mb-4">Crear Producto</h2>

<!-- MENSAJES TEMPORALES -->
@if (TempData["SuccessCategoria"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert" id="alertCategoria">
        ✅ @TempData["SuccessCategoria"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorCategoria"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert" id="alertCategoria">
        ⚠️ @TempData["ErrorCategoria"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="Create" method="post" class="card p-3 shadow-sm">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="mb-3">
        <label class="form-label">Nombre</label>
        <input asp-for="Nombre" class="form-control" />
        <span asp-validation-for="Nombre" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Categoría</label>
        <div class="input-group">
            <select asp-for="IdCategoria" asp-items="ViewBag.CategoriasSelect" class="form-select">
                <option value="">--Seleccione--</option>
            </select>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalCategoria">+</button>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Marca</label>
        <div class="input-group">
            <select asp-for="IdMarca" asp-items="ViewBag.MarcasSelect" class="form-select">
                <option value="">--Seleccione--</option>
            </select>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalMarca">+</button>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Proveedor</label>
        <select name="idProveedor" class="form-select">
            <option value="">--Seleccione--</option>
            @foreach (var p in ViewBag.Proveedores)
            {
                <option value="@p.IdProveedor">@p.Nombre</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Especificaciones</label>
        <textarea asp-for="Descripcion" class="form-control" rows="2"></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">Cantidad mínima de Stock</label>
        <input name="stockMinimo" type="number" class="form-control" value="1" min="0" />
        <small class="text-muted">El sistema alertará si el stock actual llega a este nivel o menos.</small>
    </div>

    @if (ViewBag.CodigoGenerado != null)
    {
        <div class="mb-3">
            <label class="form-label">Código sugerido</label>
            <input type="text" class="form-control" value="@ViewBag.CodigoGenerado" readonly />
        </div>
    }

    <input type="hidden" asp-for="Activo" value="true" />

    <div class="d-flex justify-content-end gap-2">
        <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar</button>
    </div>
</form>

<!-- MODAL CATEGORÍAS -->
<div class="modal fade" id="modalCategoria" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Administrar Categorías</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- ALERTAS DE CATEGORÍA -->
                @if (TempData["MensajeCategoria"] != null)
                {
                    var tipo = TempData["TipoCategoria"]?.ToString() ?? "info";
                    var icono = tipo switch
                    {
                        "success" => "✅",
                        "info" => "ℹ️",
                        "warning" => "⚠️",
                        "danger" => "❌",
                        _ => "🔔"
                    };
                    <div class="alert alert-@tipo alert-dismissible fade show" id="alertCategoriaModal">
                        <span>@icono</span> @TempData["MensajeCategoria"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <!-- Crear / Editar categoría -->
                <form method="post" id="formCategoria" asp-action="CrearCategoria" class="mb-3">
                    <input type="hidden" id="idCategoria" name="id" />
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input id="nombreCategoria" name="nombre" placeholder="Nombre" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <input id="descripcionCategoria" name="descripcion" placeholder="Descripción" class="form-control" />
                        </div>
                        <div class="col-md-2 d-flex gap-2">
                            <button type="submit" id="btnGuardarCategoria" class="btn btn-success flex-grow-1">Guardar</button>
                            <button type="button" id="btnCancelarEdicion" class="btn btn-secondary flex-grow-1" style="display:none;">Cancelar</button>
                        </div>
                    </div>
                </form>

                <table class="table table-sm table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var categorias = ViewBag.CategoriasLista as List<ProyectoLogin.Models.ModelosProducts.Categoria> ?? new();
                        }
                        @foreach (var c in categorias)
                        {
                            <tr>
                                <td>@c.Nombre</td>
                                <td>@(string.IsNullOrWhiteSpace(c.Descripcion) ? "-" : c.Descripcion)</td>
                                <td>
                                    <button type="button" class="btn btn-warning btn-sm"
                                            onclick="editarCategoria('@c.IdCategoria', '@c.Nombre', '@(c.Descripcion ?? "")')">
                                        Editar
                                    </button>
                                    <form method="post" asp-action="EliminarCategoria" style="display:inline;">
                                        <input type="hidden" name="id" value="@c.IdCategoria" />
                                        <button class="btn btn-danger btn-sm">Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- MODAL MARCAS -->
<div class="modal fade" id="modalMarca" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Administrar Marcas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- ALERTAS DE MARCA -->
                @if (TempData["MensajeMarca"] != null)
                {
                    var tipo = TempData["TipoMarca"]?.ToString() ?? "info";
                    var icono = tipo switch
                    {
                        "success" => "✅",
                        "info" => "ℹ️",
                        "warning" => "⚠️",
                        "danger" => "❌",
                        _ => "🔔"
                    };
                    <div class="alert alert-@tipo alert-dismissible fade show" id="alertMarcaModal">
                        <span>@icono</span> @TempData["MensajeMarca"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <form method="post" id="formMarca" asp-action="CrearMarca" class="mb-3">
                    <input type="hidden" id="idMarca" name="id" />
                    <div class="input-group">
                        <input id="nombreMarca" name="nombre" placeholder="Nombre de marca" class="form-control" required />
                        <button type="submit" id="btnGuardarMarca" class="btn btn-success">Guardar</button>
                        <button type="button" id="btnCancelarEdicionMarca" class="btn btn-secondary" style="display:none;">Cancelar</button>
                    </div>
                </form>

                <table class="table table-sm table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var marcas = ViewBag.MarcasLista as List<ProyectoLogin.Models.ModelosProducts.Marca> ?? new();
                        }
                        @foreach (var m in marcas)
                        {
                            <tr>
                                <td>@m.Nombre</td>
                                <td>
                                    <button type="button" class="btn btn-warning btn-sm me-1"
                                            onclick="editarMarca('@m.IdMarca', '@m.Nombre')">
                                        Editar
                                    </button>
                                    <form method="post" asp-action="EliminarMarca" style="display:inline;">
                                        <input type="hidden" name="id" value="@m.IdMarca" />
                                        <button class="btn btn-danger btn-sm">Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // Auto ocultar alertas
                // Cierra automáticamente las alertas en los modales
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(a => {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(a);
                bsAlert.close();
            });
        }, 4000);

        // --- EDITAR / CANCELAR CATEGORÍA ---
        function editarCategoria(id, nombre, descripcion) {
            document.getElementById('idCategoria').value = id;
            document.getElementById('nombreCategoria').value = nombre;
            document.getElementById('descripcionCategoria').value = descripcion;
            const form = document.getElementById('formCategoria');
            form.action = '/Productos/EditarCategoria';
            document.getElementById('btnGuardarCategoria').textContent = 'Actualizar';
            document.getElementById('btnGuardarCategoria').classList.replace('btn-success', 'btn-warning');
            document.getElementById('btnCancelarEdicion').style.display = 'inline-block';
        }

        document.getElementById('btnCancelarEdicion').addEventListener('click', () => {
            const form = document.getElementById('formCategoria');
            form.reset();
            form.action = '/Productos/CrearCategoria';
            document.getElementById('btnGuardarCategoria').textContent = 'Guardar';
            document.getElementById('btnGuardarCategoria').classList.replace('btn-warning', 'btn-success');
            document.getElementById('btnCancelarEdicion').style.display = 'none';
        });

        // --- EDITAR / CANCELAR MARCA ---
        function editarMarca(id, nombre) {
            document.getElementById('idMarca').value = id;
            document.getElementById('nombreMarca').value = nombre;
            const form = document.getElementById('formMarca');
            form.action = '/Productos/EditarMarca';
            document.getElementById('btnGuardarMarca').textContent = 'Actualizar';
            document.getElementById('btnGuardarMarca').classList.replace('btn-success', 'btn-warning');
            document.getElementById('btnCancelarEdicionMarca').style.display = 'inline-block';
        }

        document.getElementById('btnCancelarEdicionMarca').addEventListener('click', () => {
            const form = document.getElementById('formMarca');
            form.reset();
            form.action = '/Productos/CrearMarca';
            document.getElementById('btnGuardarMarca').textContent = 'Guardar';
            document.getElementById('btnGuardarMarca').classList.replace('btn-warning', 'btn-success');
            document.getElementById('btnCancelarEdicionMarca').style.display = 'none';
        });

        // --- Reabrir modal tras acción ---
        document.addEventListener('DOMContentLoaded', function() {
            const modalToOpen = '@TempData["AbrirModal"]';
            if (modalToOpen === 'Categoria') new bootstrap.Modal('#modalCategoria').show();
            else if (modalToOpen === 'Marca') new bootstrap.Modal('#modalMarca').show();
        });
    </script>
}
