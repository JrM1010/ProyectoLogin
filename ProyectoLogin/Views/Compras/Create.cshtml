@model ProyectoLogin.Models.ModelosCompras.Compra

@{
    var proveedores = ViewBag.Proveedores as List<ProyectoLogin.Models.Proveedor>;
    var productos = ViewBag.Productos as List<ProyectoLogin.Models.ModelosProducts.ProductoCore>;
    var unidades = ViewBag.Unidades as List<ProyectoLogin.Models.UnidadesDeMedida.UnidadMedida>;
    int? proveedorSel = ViewBag.ProveedorSeleccionado as int?;
}

<h2>Nueva Compra</h2>

<!-- FORMULARIO DE PROVEEDOR -->
<form method="get" action="/Compras/Create">
    <div class="mb-3">
        <label>Proveedor:</label>
        <select name="idProveedor" class="form-control" onchange="this.form.submit()">
            <option value="">-- Seleccione un proveedor --</option>
            @foreach (var p in proveedores)
            {
                if (proveedorSel == p.IdProveedor)
                {
                    <option value="@p.IdProveedor" selected>@p.Nombre</option>
                }
                else
                {
                    <option value="@p.IdProveedor">@p.Nombre</option>
                }
            }
        </select>
    </div>
</form>

<hr />

<!-- FORMULARIO DE COMPRA -->
<form method="post" action="/Compras/Create">
    <input type="hidden" name="IdProveedor" value="@proveedorSel" />

    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Producto</th>
                <th>Presentacion</th>
                <th>Cantidad</th>
                <th>Precio Unitario (Q)</th>
                <th>Subtotal (Q)</th> <!-- 🟩 NUEVO -->
                <th></th>
            </tr>
        </thead>
        <tbody id="detallesBody"></tbody>
        <tfoot>
            <tr>
                <td colspan="4" class="text-end fw-bold">TOTAL COMPRA (Q):</td>
                <td id="totalCompra" class="fw-bold text-success">0.00</td> <!-- 🟩 NUEVO -->
                <td></td>
            </tr>
        </tfoot>
    </table>

    <input type="hidden" id="Subtotal" name="Subtotal" value="0" /> <!-- 🟩 NUEVO -->

    <button type="button" class="btn btn-secondary btn-sm" onclick="addRow()">Agregar producto</button>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Guardar compra</button>
        <a href="/Compras/Index" class="btn btn-secondary">Cancelar</a>
    </div>
</form>



<!-- =============== SCRIPT =============== -->
<script>
    let index = 0;

    // Productos del proveedor con sus unidades
    const productos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Productos ?? new List<object>()));

    function addRow() {
        if (!productos || productos.length === 0) {
            alert("Seleccione primero un proveedor que tenga productos disponibles.");
            return;
        }

        const tbody = document.getElementById('detallesBody');
        const tr = document.createElement('tr');
        tr.id = 'row_' + index;

        tr.innerHTML = `
            <td>
                <select name="detalles[${index}].IdProducto" class="form-control productoSelect" required>
                    <option value="">-- Producto --</option>
                    ${productos.map(p => `<option value="${p.IdProducto}">${p.Nombre}</option>`).join('')}
                </select>
            </td>
            <td>
                <select name="detalles[${index}].IdUnidad" class="form-control unidadSelect" required disabled>
                    <option value="">-- Unidad --</option>
                </select>
            </td>
            <td><input name="detalles[${index}].Cantidad" type="number" min="1" value="1" class="form-control cantidad" required /></td>
            <td><input name="detalles[${index}].PrecioUnitario" type="number" min="0" step="0.01" value="0.00" class="form-control precio" required /></td>
            <td class="subtotal text-end">0.00</td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(${index})">X</button></td>
        `;
        tbody.appendChild(tr);
        index++;

        actualizarEventos();
        calcularTotales();
    }

    function removeRow(i) {
        const row = document.getElementById('row_' + i);
        if (row) row.remove();
        calcularTotales();
    }

    // --- Cargar unidades según producto seleccionado ---
    function handleProductoChange(event) {
        const productoId = parseInt(event.target.value);
        const row = event.target.closest('tr');
        const unidadSelect = row.querySelector('.unidadSelect');

        unidadSelect.innerHTML = '<option value="">-- Unidad --</option>';
        unidadSelect.disabled = true;

        const producto = productos.find(p => p.IdProducto === productoId);
        if (producto && producto.Unidades?.length > 0) {
            producto.Unidades.forEach(u => {
                unidadSelect.innerHTML += `<option value="${u.IdUnidad}" data-factor="${u.FactorConversion}">${u.Nombre} (x${u.FactorConversion})</option>`;
            });
            unidadSelect.disabled = false;
        }
    }

    // --- Recalcula precio y subtotal al cambiar unidad ---
    function handleUnidadChange(event) {
        const select = event.target;
        const factor = parseFloat(select.selectedOptions[0]?.getAttribute('data-factor') || 1);
        const row = select.closest('tr');
        const precioInput = row.querySelector('.precio');
        const cantidadInput = row.querySelector('.cantidad');

        const precioBase = parseFloat(precioInput.getAttribute('data-base') || precioInput.value || 0);

        // Guardar precio base la primera vez
        if (!precioInput.getAttribute('data-base')) {
            precioInput.setAttribute('data-base', precioBase);
        }

        // Recalcular según factor de conversión
        const nuevoPrecio = factor > 1
            ? (precioBase * factor)
            : (precioBase / (factor || 1));

        precioInput.value = nuevoPrecio.toFixed(2);
        calcularTotales();
    }

    // --- Calcula subtotales y total ---
    function calcularTotales() {
        let total = 0;
        document.querySelectorAll('#detallesBody tr').forEach(row => {
            const cantidad = parseFloat(row.querySelector('.cantidad')?.value || 0);
            const precio = parseFloat(row.querySelector('.precio')?.value || 0);
            const subtotal = cantidad * precio;
            row.querySelector('.subtotal').textContent = subtotal.toLocaleString('es-GT', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            total += subtotal;
        });
        document.getElementById('totalCompra').textContent = total.toLocaleString('es-GT', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // --- Asignar eventos ---
    function actualizarEventos() {
        document.querySelectorAll('.productoSelect').forEach(sel => {
            sel.removeEventListener('change', handleProductoChange);
            sel.addEventListener('change', handleProductoChange);
        });

        document.querySelectorAll('.unidadSelect').forEach(sel => {
            sel.removeEventListener('change', handleUnidadChange);
            sel.addEventListener('change', handleUnidadChange);
        });

        document.querySelectorAll('.cantidad, .precio').forEach(input => {
            input.removeEventListener('input', calcularTotales);
            input.addEventListener('input', calcularTotales);
        });
    }
</script>

